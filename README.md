# Laravelでテスト駆動開発を学ぼう！
「Laravelでテスト駆動開発を学ぼう！」という教材を購入してやってみました。  
(2020/11/23)


教材のURL  
https://www.techpit.jp/courses/92  

教材を作った人のnote  
https://note.com/nunulk/n/nbcd3f7c001dd

## ユニットテスト
ユニットテストの優先度。やはり全てを網羅するのは難しいので、
```
プロダクトのコアな機能（金額計算、コンバージョンに至る経路上にある処理、など）
変更頻度の高いもの（割引ロジック、サービスに付帯するオプション、など）
パターンの多いもの（利用プランによる各種制御、ユーザーのアクションに応じた通知、など）

複雑な計算
複雑な条件
多数のパターン
```
逆にいうと上記のパターンに当てはまる複雑な処理にはユニットテストがあったほうが絶対にいい。
（仕事で複雑な判定ロジックの際にユニットテストを作りましたが、安心感が全然違うと感じた。）

また、そういうパターンでは表を書いてパターン出しをするといいと感じた。(2-2)

ユニットテストを見据えて、テストしやすいモジュール構成でないといけない。「1つの関数は1つの仕事」を守るのが大事だと思う。可読性の面でも。 
テストをきちんと用意しておくと、要件変更や機能追加がかなりしやすくなる。短い時間で安全に対応できるようになる。

## フィーチャーテスト
```
ビジネス的なインパクトを考えると、以下の順番で重要度が高くなるでしょう。

予約ページがエラーで表示されない（ユーザーはなにもできない）
予約できるはずなのに不具合によりできない（機会損失が発生する）
予約できないはずなのにできる（予約処理でエラーになればコストは小さくて済む）
なにができる／できないとどうなるのかが分かれば、自ずとなにをテストするべきかが見えてくるので、ぜひテストを書く前に考えてみてください。

このテストで確認したいことは少なくとも以下の4点です。

ページが正しく表示できること
空き状況が正しく表示できること
予約可能条件を満たしていないときは予約できない（予約ボタンが押せない）こと
予約可能条件を満たしているときは予約できる（予約ボタンが押せる）こと
```
## モデルファクトリ
stateを今まであまり使ったことがなかったが、使ったほうが絶対に良さそう。  
複雑なリレーションのあるモデルはトレイトににして共通化していろんなテストで汎用的に使えるようにしたほうがいい。

## フェイク
Storageのフェイクを使いたい。画像のアップロードのテストをスッキリ書けるようにしたい。

## 技術的負債
```
放置している間、ロスやコストを生み続ける技術的な問題

ここでいう「ロスやコスト」とは、たとえば、新しく導入したい機能がユーザーに価値を与えることが予想できているが、実装に時間がかかるため提供が遅れてしまい、結果として発生する機会損失や、不具合が多発し、その修正に時間を取られた結果として発生する余計な時間的・金銭的損失や費用などのことを指します。
```
「技術的負債の四象限」
意図的/不注意、慎重/無謀の組み合わせによって分類されている。

```
第一象限: いますぐリリースしないと。あとでどうにかしよう（意図的 + 慎重）
第二象限: 設計する時間なんてないよ（意図的 + 無謀）
第三象限: レイヤー化ってなに？（不注意 + 無謀）
第四象限: どうすべきだったかいまになってやっと分かった（不注意 + 慎重）
```
1 意図的 + 慎重  
->緊急事態でこの選択をしないといけないことはあるが、リファクタリングやテストを書くタイミングをきちんと計画的に決めておく。  

2 意図的 + 無謀  
->短期的なベネフィットのために戦略的に行う場合、リファクタリングの計画をきちんと決めておく。一方でスキル不足の言い訳に使われることも多いので、そこは目を背けず、少しずつスキルの底上げしていくよりない。

3 不注意 + 無謀  
->そもそもテストしやすい設計についての基礎知識が全体的に不足している。知識の底上げをしていくよりない。  

4 不注意 + 慎重  
->「ふりかえり」のような定期的なミーティングの場で、技術的負債を放置していないか、どうすれば返済（解消）できるか話し合ってみる。  

テストを書く事によるベネフィットとコストのバランスを考えて、「無謀」なケースを減らしていくとこが大事。

## 資産としてのテスト
テストが書いてあることにより、変更や機能追加にかかる時間を小さくするのに役立っていれば、それは資産と見なすことができる。（実際にエンジニアの作業時間を短くしてコストを下げるのに貢献する）

```
コードカバレッジにはいくつかの種類がありますので、かいつまんで紹介します。

1 ステートメントカバレッジは、コード内のすべての命令が実行された場合に100%になります。
2 ブランチカバレッジは、コード内のすべての条件分岐を通ったら100%になります。
3 マルチコンディションカバレッジは、すべての条件を満たした場合に100%になります。
```

## 全体的な感想　
- テスト駆動開発は基本的にはやっていきたいが、機能追加がViewファイル（HTML）の追加がメインで、あまりロジックが絡まない場合、適用しづらい気がする。
- 開発にかかるトータルの時間は、TDDの時と普通（プロダクションコードを書いてからテストを書く）の時でどのくらい違うのか？　例えばスケジュールがかなり厳しい開発や機能追加がある場合、TDDをやるのは時間的にはどうなのか？
- TDDの3つのフェーズを細かく切り分けて早くサイクルを回すのが大事
→どのくらいの粒度がいいのかよくわからない。「小さく書いて素早く回す」と言われても、最初に200を出すところまでやるのができるが、そのあとはもう最終完成系まで行ってしまう。切り分け方がわからない。
→なるべくテストしたいことを箇条書きにしたり、TODOにして羅列するといい
- フィーチャーテストの範囲をどこまでやるか。200が返ってくる事だけにするか、データベースがきちんと更新されているか、レスポンスの中身が期待したものかまで見るのかは難しい。
- テストをきちんと書くことによるエンジニアの安心感は、単なる精神論を超えてかなり大事だと思う。それによってストレスをなるべく減らすのが開発へのモチベーションアップにもつながり、結果的により良いプロダクトができたり、より多くの機能追加ができると思う。

## 教材に対する感想
- TDDの思想や理念的な部分から、Laravelでの便利なテストの書き方など幅広く学ぶことができて良かった。
- 丁寧に解説してくれる部分と、練習問題を出してくれるバランスがよくて、インプットとアウトプットのバランスが良かった。
